<script>
document.addEventListener('DOMContentLoaded', () => {
  const getRadioScore=(name,val)=>{const r=document.querySelector('input[name="'+name+'"]:checked');return r&&r.value===val?1:0;}
  const getTextScore=(id,ans)=>{const t=document.getElementById(id).value.trim().toLowerCase();return t.includes(ans)?1:0;}
  const wordCount=s=>s.trim().split(/\s+/).filter(Boolean).length;

  const readingTests=[
    {btn:'btnA1T1',id:'A1T1',score:()=>getRadioScore('a1t1_q1','6')+getRadioScore('a1t1_q2','mark')+getTextScore('a1t1_q3','bus')},
    {btn:'btnA1T2',id:'A1T2',score:()=>getRadioScore('a1t2_q1','plumber')+getTextScore('a1t2_q2','12:30')},
    {btn:'btnA2T1',id:'A2T1',score:()=>getRadioScore('a2t1_q1','beach')+getTextScore('a2t1_q2','leader')},
    {btn:'btnA2T2',id:'A2T2',score:()=>getRadioScore('a2t2_q1','experience')+getTextScore('a2t2_q2','start')},
    {btn:'btnA2T3',id:'A2T3',score:()=>getRadioScore('a2t3_q1','b')},
    {btn:'btnB1T1',id:'B1T1',score:()=>getRadioScore('b1t1_q1','language')+getTextScore('b1t1_q2','communicate')},
    {btn:'btnB1T2',id:'B1T2',score:()=>getRadioScore('b1t2_q1','safety')+getTextScore('b1t2_q2','wearing')},
    {btn:'btnB1T3',id:'B1T3',score:()=>getTextScore('b1t3_q1','apologize')+getTextScore('b1t3_q1','sorry')}
  ];
  readingTests.forEach(t=>{
    document.getElementById(t.btn).addEventListener('click',()=>{
      const s=t.score();
      document.getElementById('result'+t.id).innerHTML=`<strong>Score:</strong> ${s}`;
    });
  });

  // ===== Writing Buttons (with examiner scoring) =====
  document.getElementById('btnEssay').addEventListener('click',()=>{
    const wc = wordCount(document.getElementById('essayText').value);
    document.getElementById('resultEssay').innerHTML = `<strong>Essay Word Count:</strong> ${wc}`;
    showWritingEvaluation('essay', 'essayText', 'resultEssay');
  });

  document.getElementById('btnEmail').addEventListener('click',()=>{
    const wc = wordCount(document.getElementById('emailText').value);
    document.getElementById('resultEmail').innerHTML = `<strong>Email Word Count:</strong> ${wc}`;
    showWritingEvaluation('email', 'emailText', 'resultEmail');
  });

  // ===== Auto Writing Level =====
  function writingScoreAndLevel(w) {
    if (w < 10) return { score: 0, level: 'Below A1' };
    if (w < 20) return { score: 1, level: 'A1' };
    if (w < 50) return { score: 2, level: 'A2' };
    if (w < 100) return { score: 3, level: 'B1' };
    if (w < 200) return { score: 4, level: 'B2' };
    return { score: 5, level: 'C1' };
  }

  // ===== Examiner Partial Credit Section =====
  function showWritingEvaluation(sectionId, textId, resultId) {
    const writingText = document.getElementById(textId).value.trim();
    const wc = writingText.split(/\s+/).filter(Boolean).length;
    const auto = writingScoreAndLevel(wc);

    const container = document.getElementById(resultId);
    container.innerHTML = `
      <p><strong>Word Count:</strong> ${wc}</p>
      <p><strong>Auto Level:</strong> ${auto.level} (Base Score: ${auto.score})</p>
      <hr>
      <h4>Examiner Partial Credits (0–5 each)</h4>
      <label>Formatting: <input type="number" id="${sectionId}_fmt" min="0" max="5" value="0"></label><br>
      <label>Structure: <input type="number" id="${sectionId}_str" min="0" max="5" value="0"></label><br>
      <label>Grammar: <input type="number" id="${sectionId}_grm" min="0" max="5" value="0"></label><br>
      <label>Vocabulary: <input type="number" id="${sectionId}_vocab" min="0" max="5" value="0"></label><br><br>
      <button onclick="computeFinalWritingScore('${sectionId}', ${auto.score})">Compute Final Score</button>
      <div id="${sectionId}_final" style="margin-top:10px;font-weight:bold;"></div>
    `;
  }

  window.computeFinalWritingScore = function(sectionId, baseScore) {
    const fmt = +document.getElementById(sectionId + "_fmt").value || 0;
    const str = +document.getElementById(sectionId + "_str").value || 0;
    const grm = +document.getElementById(sectionId + "_grm").value || 0;
    const vocab = +document.getElementById(sectionId + "_vocab").value || 0;
    const total = baseScore + fmt + str + grm + vocab;
    document.getElementById(sectionId + "_final").innerText =
      `Total Adjusted Score: ${total}/25`;
  }

  function determineCEFR(r){
    const a1Full = r.A1 >= 4;
    const a2Full = r.A2 >= 4;
    const b1Full = r.B1 >= 4;
    if (a1Full && a2Full && b1Full) return 'B1';
    if (a1Full && a2Full) return 'A2';
    if (a1Full) return 'A1';
    return 'Below A1';
  }

  // ===== Save to PDF =====
  document.getElementById('btnSavePDF').addEventListener('click',()=>{
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF();
    const name=document.getElementById('candidateName').value.trim()||'(No name)';

    // reading totals
    const getScore=id=>parseInt((document.getElementById('result'+id)?.innerText.match(/\d+/)||[0])[0]);
    const rs={A1:getScore('A1T1')+getScore('A1T2'),A2:getScore('A2T1')+getScore('A2T2')+getScore('A2T3'),B1:getScore('B1T1')+getScore('B1T2')+getScore('B1T3')};

    // writing counts and evaluations
    const essayText=document.getElementById('essayText').value.trim();
    const essayW=wordCount(essayText);
    const emailText=document.getElementById('emailText').value.trim();
    const emailW=wordCount(emailText);

    const essayEval=writingScoreAndLevel(essayW);
    const emailEval=writingScoreAndLevel(emailW);
    const readingLevel=determineCEFR(rs);

    // examiner partial scores
    const essayFmt=+document.getElementById('essay_fmt')?.value||0;
    const essayStr=+document.getElementById('essay_str')?.value||0;
    const essayGrm=+document.getElementById('essay_grm')?.value||0;
    const essayVocab=+document.getElementById('essay_vocab')?.value||0;
    const essayFinal=essayEval.score+essayFmt+essayStr+essayGrm+essayVocab;

    const emailFmt=+document.getElementById('email_fmt')?.value||0;
    const emailStr=+document.getElementById('email_str')?.value||0;
    const emailGrm=+document.getElementById('email_grm')?.value||0;
    const emailVocab=+document.getElementById('email_vocab')?.value||0;
    const emailFinal=emailEval.score+emailFmt+emailStr+emailGrm+emailVocab;

    // ===== PDF layout =====
    let y=20;
    doc.setFontSize(16); doc.text(`Candidate: ${name}`,10,y); y+=10;
    doc.setFontSize(14); doc.text('Reading Comprehension',10,y); y+=8; doc.setFontSize(12);
    doc.text(`A1 Total: ${rs.A1}`,10,y); y+=6;
    doc.text(`A2 Total: ${rs.A2}`,10,y); y+=6;
    doc.text(`B1 Total: ${rs.B1}`,10,y); y+=8;
    doc.text(`Highest Reading Level: ${readingLevel}`,10,y); y+=12;
    doc.setFontSize(14); doc.text('Writing Results',10,y); y+=8; doc.setFontSize(12);
    doc.text(`Essay Word Count: ${essayW} → Level: ${essayEval.level}`,10,y); y+=6;
    doc.text(`  Formatting: ${essayFmt}  Structure: ${essayStr}  Grammar: ${essayGrm}  Vocabulary: ${essayVocab}`,10,y); y+=6;
    doc.text(`  Final Adjusted Score: ${essayFinal}/25`,10,y); y+=8;
    doc.text(`Email Word Count: ${emailW} → Level: ${emailEval.level}`,10,y); y+=6;
    doc.text(`  Formatting: ${emailFmt}  Structure: ${emailStr}  Grammar: ${emailGrm}  Vocabulary: ${emailVocab}`,10,y); y+=6;
    doc.text(`  Final Adjusted Score: ${emailFinal}/25`,10,y); y+=10;
    doc.setFontSize(14); doc.text('Overall Summary',10,y); y+=8; doc.setFontSize(12);
    doc.text(`Reading Level: ${readingLevel}`,10,y); y+=6;
    doc.text(`Writing Level: ${essayEval.level===emailEval.level?essayEval.level:essayEval.level+'/'+emailEval.level}`,10,y); y+=10;
    doc.text('End of Report',10,y);
    const filename=`${name.replace(/\s+/g,'_')||'Candidate'}_Results.pdf`;
    doc.save(filename);
  });
});
</script>
